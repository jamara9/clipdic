<html>
<head>
<script src="common.js"></script>
<script>

function getClipboard()
{
	var t = document.getElementById("inputbox");
	
	t.value = "";
	
	t.focus();
	document.execCommand('Paste');
	
	return t.value;
}

var lastTab = null;
function onTabOpened(newTab)
{
	// To prevent many tabs opened, Remember ths last tab
	lastTab = newTab;
}

function openNewPage(word)
{
	var newUrl = getBaseUrl() + word;
	
	if ( lastTab != null )
	{
		chrome.tabs.update(lastTab.id, { "url" : newUrl }, onTabOpened);
	}
	else
	{
		chrome.tabs.create({ "url" : newUrl }, onTabOpened);
	}
}

function isValidWord(word)
{
	if ( word.startsWith("http://") ) return false;
	if ( word.startsWith("//") ) return false;
	
	return true;
}

var lastValue = "";
function onTimer()
{
	var thisValue = getClipboard().trim();

	// if clipboard value is changed,
	if ( lastValue != thisValue )
	{
		lastValue = thisValue;

		if ( isValidWord(thisValue) )
		{
			openNewPage(thisValue);
		}
	}
}

function onClickedExtensionIcon()
{
	if ( lastTab == null )
	{
		appOn();
	}
	else
	{
		appOff();
	}
}

var timerID = 0;
function appOn()
{
	lastTab = null;
	timerID = window.setInterval(onTimer, 100);
	
	openNewPage("dictionary");
	chrome.browserAction.setIcon({path: 'icon16.png'});
}

function appOff()
{
	lastTab = null;
	window.clearInterval(timerID);
	
	chrome.browserAction.setIcon({path: 'icon16_bw.png'});
}

function onRemovedTab(tabId, removeInfo)
{
	if ( lastTab != null )
	{
		if ( lastTab.id == tabId )
		{
			appOff();
		}
	}
}


chrome.tabs.onRemoved.addListener(onRemovedTab);
chrome.browserAction.onClicked.addListener(onClickedExtensionIcon);

</script>
</head>
<body>
<!-- below input box is for pasting current clipboard content -->
<input type="text" id="inputbox" />
</body>
</html>